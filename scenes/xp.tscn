[gd_scene load_steps=5 format=3 uid="uid://bj21kednqhkuy"]

[ext_resource type="Texture2D" uid="uid://13541gqaf60d" path="res://assets/imgs/xp_orb.png" id="2_qp56h"]
[ext_resource type="AudioStream" uid="uid://cqojtcpu5i87q" path="res://assets/audio/xp_pickup.mp3" id="3_qp56h"]

[sub_resource type="GDScript" id="GDScript_8cwu2"]
script/source = "extends Area2D


@export var min_speed: float = 0.003        # Speed when player is at the edge of detection_range
@export var max_speed: float = 500.0        # Speed when player is very close
@export var detection_range: float = 140.0  # How far the player needs to be to start attracting XP
@export var xp = 0
@onready var xp_pickup_sfx = $AudioStreamPlayer2D

func _ready():
	add_to_group(\"xp\")


func _on_body_entered(body):
	if body == GlobalData.player:
		body.gain_xp(1)
		pickup()
		

func _physics_process(delta: float) -> void:
	var player_pos = GlobalData.player.global_position
	var dist = global_position.distance_to(player_pos)
	if dist < detection_range and detection_range > 0:
		var closeness_ratio = 1.0 - clamp(dist / detection_range, 0.0, 1.0)
		var current_speed = lerp(min_speed, max_speed, closeness_ratio)
		var direction = (player_pos - global_position).normalized()
		global_position += direction * current_speed * delta

func pickup():
	shutup()
	GlobalData.player.xp += 1
	xp_pickup_sfx.pitch_scale = randi_range(0.1,4)
	xp_pickup_sfx.play()
	$Sprite2D.hide()
	$Timer.start()
	
func _on_timer_timeout() -> void:
	queue_free()

func shutup():
	for node in get_tree().get_nodes_in_group(\"xp\"):
		node.xp_pickup_sfx.stop()
"

[sub_resource type="CircleShape2D" id="CircleShape2D_fycud"]
radius = 7.07107

[node name="Xp" type="Area2D" groups=["xp"]]
z_index = -1
collision_layer = 4
script = SubResource("GDScript_8cwu2")

[node name="Sprite2D" type="Sprite2D" parent="."]
texture = ExtResource("2_qp56h")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = SubResource("CircleShape2D_fycud")

[node name="Timer" type="Timer" parent="."]
wait_time = 0.356

[node name="AudioStreamPlayer2D" type="AudioStreamPlayer2D" parent="."]
stream = ExtResource("3_qp56h")
pitch_scale = 0.01
bus = &"SFX"

[connection signal="body_entered" from="." to="." method="_on_body_entered"]
[connection signal="timeout" from="Timer" to="." method="_on_timer_timeout"]
